<!DOCTYPE html>
<html lang="ja">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FF6B35">
    <title>Hirolia - ãƒ¬ã‚¸æ¡ˆå†…</title>
    <link rel="stylesheet" href="/static/css/customer.css">
    <style>
        .receipt-container {
            max-width: 500px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-xl);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: var(--radius-lg);
            color: white;
        }
        
        .receipt-icon {
            font-size: 64px;
            margin-bottom: var(--spacing-md);
        }
        
        .receipt-title {
            font-size: var(--font-xl);
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
        }
        
        .receipt-subtitle {
            font-size: var(--font-md);
            opacity: 0.9;
        }
        
        .receipt-info {
            background-color: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow);
        }
        
        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .receipt-row:last-child {
            border-bottom: none;
        }
        
        .receipt-label {
            color: var(--text-secondary);
        }
        
        .receipt-value {
            font-weight: 600;
        }
        
        .receipt-total {
            background-color: var(--primary-color);
            color: white;
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
            text-align: center;
        }
        
        .receipt-total-label {
            font-size: var(--font-md);
            margin-bottom: var(--spacing-xs);
        }
        
        .receipt-total-amount {
            font-size: 48px;
            font-weight: 700;
        }
        
        .receipt-instruction {
            text-align: center;
            padding: var(--spacing-xl);
            background-color: var(--bg-secondary);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-lg);
        }
        
        .receipt-instruction-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-md);
        }
        
        .receipt-instruction-text {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .thank-you {
            text-align: center;
            padding: var(--spacing-xl);
            font-size: var(--font-xl);
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .order-summary {
            margin-bottom: var(--spacing-xl);
        }
        
        .order-summary-item {
            background-color: var(--bg-secondary);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
        }
        
        .order-summary-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }
        
        .order-summary-details {
            font-size: var(--font-sm);
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container" style="background-color: var(--bg-secondary);">
        <div class="receipt-container">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="receipt-header">
                <div class="receipt-icon">âœ…</div>
                <div class="receipt-title" data-i18n="checkout_complete">ä¼šè¨ˆã‚’ç¢ºå®šã—ã¾ã—ãŸ</div>
                <div class="receipt-subtitle">
                    <span id="checkout-time"></span>
                </div>
            </div>
            
            <!-- ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ± -->
            <div class="receipt-info">
                <div class="receipt-row">
                    <span class="receipt-label">ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·</span>
                    <span class="receipt-value" id="table-number">-</span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">æ³¨æ–‡ä»¶æ•°</span>
                    <span class="receipt-value" id="order-count">0ä»¶</span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">åˆè¨ˆå•†å“æ•°</span>
                    <span class="receipt-value" id="item-count">0ç‚¹</span>
                </div>
            </div>
            
            <!-- æ³¨æ–‡ã‚µãƒãƒªãƒ¼ -->
            <div class="order-summary" id="order-summary">
                <!-- JavaScriptã§ç”Ÿæˆ -->
            </div>
            
            <!-- åˆè¨ˆé‡‘é¡ -->
            <div class="receipt-total">
                <div class="receipt-total-label" data-i18n="total">åˆè¨ˆé‡‘é¡</div>
                <div class="receipt-total-amount" id="total-amount">Â¥0</div>
            </div>
            
            <!-- ãƒ¬ã‚¸æ¡ˆå†… -->
            <div class="receipt-instruction">
                <div class="receipt-instruction-icon">ğŸ’³</div>
                <div class="receipt-instruction-text" data-i18n="show_at_register">
                    ã“ã®ç”»é¢ã‚’ãƒ¬ã‚¸ã§ãŠè¦‹ã›ãã ã•ã„
                </div>
            </div>
            
            <!-- ã‚ã‚ŠãŒã¨ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="thank-you">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ™</div>
                <div data-i18n="thank_you">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</div>
            </div>
            
            <!-- æ³¨æ„äº‹é … -->
            <div class="card text-center" style="background-color: rgba(255, 107, 53, 0.1); border: 2px solid var(--primary-color);">
                <p style="color: var(--primary-color); font-weight: 600;">
                    âš ï¸ ã“ã®ç”»é¢ã‹ã‚‰è¿½åŠ æ³¨æ–‡ã¯ã§ãã¾ã›ã‚“
                </p>
            </div>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        // ====================================
        // ãƒ¬ã‚¸æ¡ˆå†…ç”»é¢ JavaScript
        // ====================================
        
        // DOMè¦ç´ 
        const checkoutTimeDisplay = document.getElementById('checkout-time');
        const tableNumberDisplay = document.getElementById('table-number');
        const orderCountDisplay = document.getElementById('order-count');
        const itemCountDisplay = document.getElementById('item-count');
        const totalAmountDisplay = document.getElementById('total-amount');
        const orderSummaryContainer = document.getElementById('order-summary');
        
        // ä¼šè¨ˆæƒ…å ±ã®è¡¨ç¤º
        function displayReceipt() {
            const session = getSessionData();
            
            // ä¼šè¨ˆæ¸ˆã¿ã§ãªã„å ´åˆã¯æ³¨æ–‡å±¥æ­´ã«æˆ»ã™
            if (!session.isCheckedOut || !session.checkoutData) {
                navigateTo('/customer/history');
                return;
            }
            
            const checkoutData = session.checkoutData;
            const lang = getCurrentLanguage();
            
            // æ™‚åˆ»
            const checkoutTime = new Date(checkoutData.checkoutTime);
            checkoutTimeDisplay.textContent = checkoutTime.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·
            tableNumberDisplay.textContent = checkoutData.tableNumber;
            
            // æ³¨æ–‡ä»¶æ•°
            orderCountDisplay.textContent = `${checkoutData.orders.length}ä»¶`;
            
            // å•†å“æ•°
            let totalItems = 0;
            checkoutData.orders.forEach(order => {
                order.items.forEach(item => {
                    totalItems += item.quantity;
                });
            });
            itemCountDisplay.textContent = `${totalItems}ç‚¹`;
            
            // åˆè¨ˆé‡‘é¡
            totalAmountDisplay.textContent = formatPrice(checkoutData.totalAmount);
            
            // æ³¨æ–‡ã‚µãƒãƒªãƒ¼ã®æç”»
            renderOrderSummary(checkoutData.orders, lang);
        }
        
        // æ³¨æ–‡ã‚µãƒãƒªãƒ¼ã®æç”»
        function renderOrderSummary(orders, lang) {
            orderSummaryContainer.innerHTML = '';
            
            orders.forEach((order, orderIndex) => {
                const orderTime = new Date(order.orderTime);
                const timeString = orderTime.toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                order.items.forEach(item => {
                    const name = item[`name_${lang}`] || item.name_ja;
                    
                    // å°è¨ˆè¨ˆç®—
                    let itemTotal = item.price * item.quantity;
                    if (item.options) {
                        if (item.options.main) itemTotal += item.options.main.price * item.quantity;
                        if (item.options.drink) itemTotal += item.options.drink.price * item.quantity;
                        if (item.options.toppings) {
                            item.options.toppings.forEach(topping => {
                                itemTotal += topping.price * item.quantity;
                            });
                        }
                    }
                    
                    const div = document.createElement('div');
                    div.className = 'order-summary-item';
                    div.innerHTML = `
                        <div class="order-summary-header">
                            <span>${name} Ã—${item.quantity}</span>
                            <span>${formatPrice(itemTotal)}</span>
                        </div>
                        <div class="order-summary-details">â° ${timeString}</div>
                    `;
                    
                    orderSummaryContainer.appendChild(div);
                });
            });
        }
        
        // UIè¨€èªã®æ›´æ–°
        function updateUILanguage() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.dataset.i18n;
                element.textContent = t(key);
            });
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå®Ÿéš›ã®APIã‚³ãƒ¼ãƒ«ã«ç½®ãæ›ãˆã‚‹ï¼‰
        function resetTable() {
            const session = getSessionData();
            console.log('Table reset triggered for table:', session.tableNumber);
            
            // ã“ã“ã§å®Ÿéš›ã®APIã‚’å‘¼ã³å‡ºã—ã¦ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            // - seat_sessions.status â†’ 'ended'
            // - seat_sessions.ended_at â†’ ç¾åœ¨æ™‚åˆ»
            // - tables.status â†’ 'available'
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
            const session = getSessionData();
            if (!session.tableNumber || !session.language) {
                navigateTo('/customer/table');
                return;
            }
            
            // UIè¨€èªã‚’æ›´æ–°
            updateUILanguage();
            
            // ãƒ¬ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
            displayReceipt();
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            resetTable();
            
            // æ³¨æ–‡å±¥æ­´ã¨ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
            localStorage.removeItem('hirolia_orders');
            clearCart();
        });
    </script>
</body>
</html>